<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matías Castillo-Aguilar">

<title>The Heart as a Stochastic Machine – 2026-XX SDE R-R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">2026-XX SDE R-R</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-physiological-foundation" id="toc-the-physiological-foundation" class="nav-link active" data-scroll-target="#the-physiological-foundation"><span class="header-section-number">1</span> The Physiological Foundation</a>
  <ul class="collapse">
  <li><a href="#introduction-beyond-the-black-box-of-hrv" id="toc-introduction-beyond-the-black-box-of-hrv" class="nav-link" data-scroll-target="#introduction-beyond-the-black-box-of-hrv"><span class="header-section-number">1.1</span> Introduction: Beyond the “Black Box” of HRV</a></li>
  <li><a href="#the-biophysics-of-a-beat-why-inverse-gaussian" id="toc-the-biophysics-of-a-beat-why-inverse-gaussian" class="nav-link" data-scroll-target="#the-biophysics-of-a-beat-why-inverse-gaussian"><span class="header-section-number">1.2</span> The Biophysics of a Beat: Why “Inverse Gaussian”?</a></li>
  </ul></li>
  <li><a href="#the-mathematical-engine" id="toc-the-mathematical-engine" class="nav-link" data-scroll-target="#the-mathematical-engine"><span class="header-section-number">2</span> The Mathematical Engine</a>
  <ul class="collapse">
  <li><a href="#point-processes-for-non-mathematicians" id="toc-point-processes-for-non-mathematicians" class="nav-link" data-scroll-target="#point-processes-for-non-mathematicians"><span class="header-section-number">2.1</span> Point Processes for Non-Mathematicians</a></li>
  <li><a href="#the-sde-revolution-modeling-the-hidden-drivers" id="toc-the-sde-revolution-modeling-the-hidden-drivers" class="nav-link" data-scroll-target="#the-sde-revolution-modeling-the-hidden-drivers"><span class="header-section-number">2.2</span> The SDE Revolution: Modeling the “Hidden Drivers”</a></li>
  <li><a href="#coupling-the-systems-sympathovagal-balance" id="toc-coupling-the-systems-sympathovagal-balance" class="nav-link" data-scroll-target="#coupling-the-systems-sympathovagal-balance"><span class="header-section-number">2.3</span> Coupling the Systems: Sympathovagal Balance</a></li>
  </ul></li>
  <li><a href="#building-the-simulation-in-r" id="toc-building-the-simulation-in-r" class="nav-link" data-scroll-target="#building-the-simulation-in-r"><span class="header-section-number">3</span> Building the Simulation in R</a>
  <ul class="collapse">
  <li><a href="#step-by-step-implementation-guide" id="toc-step-by-step-implementation-guide" class="nav-link" data-scroll-target="#step-by-step-implementation-guide"><span class="header-section-number">3.1</span> Step-by-Step Implementation Guide</a></li>
  <li><a href="#the-thinning-algorithm-simulating-the-beat" id="toc-the-thinning-algorithm-simulating-the-beat" class="nav-link" data-scroll-target="#the-thinning-algorithm-simulating-the-beat"><span class="header-section-number">3.2</span> The “Thinning” Algorithm: Simulating the Beat</a></li>
  <li><a href="#coding-the-full-digital-twin" id="toc-coding-the-full-digital-twin" class="nav-link" data-scroll-target="#coding-the-full-digital-twin"><span class="header-section-number">3.3</span> Coding the Full Digital Twin</a></li>
  </ul></li>
  <li><a href="#validation-application" id="toc-validation-application" class="nav-link" data-scroll-target="#validation-application"><span class="header-section-number">4</span> Validation &amp; Application</a>
  <ul class="collapse">
  <li><a href="#analyzing-the-virtual-patient" id="toc-analyzing-the-virtual-patient" class="nav-link" data-scroll-target="#analyzing-the-virtual-patient"><span class="header-section-number">4.1</span> Analyzing the “Virtual Patient”</a></li>
  <li><a href="#comparison-with-barbieri-et-al.-2005-the-philosophical-shift" id="toc-comparison-with-barbieri-et-al.-2005-the-philosophical-shift" class="nav-link" data-scroll-target="#comparison-with-barbieri-et-al.-2005-the-philosophical-shift"><span class="header-section-number">4.2</span> Comparison with Barbieri et al.&nbsp;(2005): The Philosophical Shift</a></li>
  <li><a href="#the-inverse-problem-becoming-a-physiological-detective" id="toc-the-inverse-problem-becoming-a-physiological-detective" class="nav-link" data-scroll-target="#the-inverse-problem-becoming-a-physiological-detective"><span class="header-section-number">4.3</span> The Inverse Problem: Becoming a Physiological Detective</a></li>
  <li><a href="#why-this-model-is-a-game-changer-for-applied-science" id="toc-why-this-model-is-a-game-changer-for-applied-science" class="nav-link" data-scroll-target="#why-this-model-is-a-game-changer-for-applied-science"><span class="header-section-number">4.4</span> Why This Model is a Game Changer for Applied Science</a></li>
  <li><a href="#conclusion-the-symphony-of-the-sinus-node" id="toc-conclusion-the-symphony-of-the-sinus-node" class="nav-link" data-scroll-target="#conclusion-the-symphony-of-the-sinus-node"><span class="header-section-number">4.5</span> Conclusion: The Symphony of the Sinus Node</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The Heart as a Stochastic Machine</h1>
<p class="subtitle lead">A ‘Zero-to-Hero’ Guide to Modeling Autonomic Dynamics</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matías Castillo-Aguilar </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="the-physiological-foundation" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> The Physiological Foundation</h1>
<section id="introduction-beyond-the-black-box-of-hrv" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="introduction-beyond-the-black-box-of-hrv"><span class="header-section-number">1.1</span> Introduction: Beyond the “Black Box” of HRV</h2>
<p>Grab a coffee, settle in, and let’s talk about the human heart. But not the romanticized version you see on Valentine’s cards, nor the simple mechanical pump your high school biology teacher described. We are going to talk about the heart as a stochastic machine (a noisy, jittery, beautiful mess of probability and biology).</p>
<p>If you have ever played a rhythm game like <em>Guitar Hero</em> or <em>Rock Band</em>, you know that hitting the note perfectly on the beat is hard. You might be a little early, a little late. Now imagine the drummer as a human being who just drank three espressos and is worried about their tax return. That drummer is your heart.</p>
<p>For decades, we have treated Heart Rate Variability (HRV) like a “black box”. You put an ECG in one side, and out pops a number like SDNN or RMSSD. We treat these numbers like magical runes that tell us if we are stressed or healthy. But that is a bit like judging a movie solely by its runtime. We are missing the plot! The heart rate is a vital sign, sure, but HRV is the actual quantitative measure of cardiovascular regulation by the autonomic nervous system.</p>
<p>The standard methods (counting beats, averaging intervals, or doing Fourier transforms) often treat the heartbeat series as a continuous signal, like a temperature reading or a stock price. But here is the kicker: heartbeats aren’t continuous signals. They are <strong>point processes</strong>. They are discrete events occurring in continuous time. A standard time-series model assumes that at every millisecond, there is a value. But there isn’t a “heartbeat value” between beats. Actually, there is just silence, followed by a sudden electrical explosion.</p>
<p>So, instead of just analyzing the output (the beats), what if we built a mathematical model of the drummer itself? What if we simulated the nervous system pulling the strings? That is what we are doing today. We are going to build a “virtual heart” from scratch, using rigorous math to describe the biology.</p>
</section>
<section id="the-biophysics-of-a-beat-why-inverse-gaussian" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="the-biophysics-of-a-beat-why-inverse-gaussian"><span class="header-section-number">1.2</span> The Biophysics of a Beat: Why “Inverse Gaussian”?</h2>
<p>To build our model, we first need to understand the hardware. The heart’s pacemaker is the Sinoatrial (SA) node, a small cluster of cells in the right atrium.</p>
<p>Think of the SA node cell like a bucket sitting under a dripping faucet. The water represents positive ions (sodium and calcium) flowing into the cell. The bucket has a “fill line” marked at the top. When the water hits that line, the bucket tips over, dumps the water, and triggers a heartbeat (an action potential). Then, the bucket sets itself back up and starts filling again immediately.</p>
<p>This mechanism is often called “Integrate-and-Fire”. The cell integrates (accumulates) voltage until it fires.</p>
<p>Now, here is where the chaos enters. The faucet isn’t dripping steadily. Some milliseconds it drips fast, some milliseconds it drips slow. This is due to the stochastic nature of ion channels opening and closing (thermal noise, essentially). So, the water level in our bucket doesn’t rise in a perfect straight line. It wiggles upward. In mathematics, we call this a <strong>Gaussian Random Walk with Drift</strong>.</p>
<p>If the voltage rise is a random walk, then the time it takes to hit the threshold is a random variable. Specifically, the probability distribution of these “First Passage Times” (the time to hit the line) is known as the <strong>Inverse Gaussian distribution</strong>.</p>
<p>This is why we choose the Inverse Gaussian for our model. We aren’t just picking a bell curve because it looks nice. We are picking the distribution that physically describes how membrane potentials rise to a threshold. It is the mathematically correct description of the “leaky bucket” mechanics of your heart cells.</p>
<p>Let’s visualize this. In the code below, we simulate the “bucket” (membrane potential) filling up with noisy water. Watch how the randomness in the filling process leads to variation in the time it takes to spill (the heartbeat).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for the Random Walk</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>drift <span class="ot">&lt;-</span> <span class="fl">0.5</span>      <span class="co"># Speed of filling</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>noise_sd <span class="ot">&lt;-</span> <span class="fl">1.5</span>   <span class="co"># How "sputtering" the faucet is</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fl">0.1</span>         <span class="co"># Time step</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>max_time <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation containers</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_time, <span class="at">by=</span>dt)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>voltage <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(time))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>voltage[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>spikes <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the "Bucket" filling</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(time)) {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random Walk step: Previous + Drift + Noise</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  step <span class="ot">&lt;-</span> drift <span class="sc">*</span> dt <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, noise_sd <span class="sc">*</span> <span class="fu">sqrt</span>(dt))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  voltage[i] <span class="ot">&lt;-</span> voltage[i<span class="dv">-1</span>] <span class="sc">+</span> step</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check Threshold</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(voltage[i] <span class="sc">&gt;=</span> threshold) {</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    voltage[i] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># Reset (Repolarization)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    spikes <span class="ot">&lt;-</span> <span class="fu">c</span>(spikes, time[i]) <span class="co"># Record the beat</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the physiological process</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(time, voltage, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">"#0072B2"</span>, <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"The Stochastic Pacemaker: Random Walk to Threshold"</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Time (ms)"</span>, <span class="at">ylab=</span><span class="st">"Membrane Potential (arbitrary units)"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">12</span>), <span class="at">frame.plot=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the Threshold</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>threshold, <span class="at">col=</span><span class="st">"#D55E00"</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">0</span>, <span class="fl">10.5</span>, <span class="st">"Firing Threshold"</span>, <span class="at">pos=</span><span class="dv">4</span>, <span class="at">col=</span><span class="st">"#D55E00"</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the Spikes (Heartbeats)</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(spikes) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(spikes, <span class="fu">rep</span>(threshold, <span class="fu">length</span>(spikes)), <span class="at">pch=</span><span class="dv">8</span>, <span class="at">col=</span><span class="st">"black"</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rug</span>(spikes, <span class="at">col=</span><span class="st">"black"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-random-walk" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-random-walk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="point-process_files/figure-html/fig-random-walk-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-random-walk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: The Integrate-and-Fire Mechanism. The blue line represents the membrane potential of a pacemaker cell. It drifts upward with noise (Brownian motion) until it hits the threshold (red dashed line). The moment it hits, a heartbeat occurs, and the potential resets. The time taken to hit the threshold is the R-R interval.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Notice in the plot above that the time between the black stars (the heartbeats) isn’t perfectly constant. Even though the <code>drift</code> (the average fill rate) is constant, the <code>noise</code> makes some beats happen early and some late. That variation? That is the most basic form of Heart Rate Variability.</p>
<p>This leads us to a critical realization provided by Barbieri et al.: if we assume the intervals are independent, we get a “Renewal Inverse Gaussian” model. But in reality, the speed of the dripping faucet changes over time because your nervous system is turning the handle! The sympathetic system opens the faucet (faster drip), and the parasympathetic system tightens it (slower drip). This means the intervals are <strong>not</strong> independent; they depend on the history of these inputs. We need a model that accounts for this dynamic history.</p>
</section>
</section>
<section id="the-mathematical-engine" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> The Mathematical Engine</h1>
<section id="point-processes-for-non-mathematicians" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="point-processes-for-non-mathematicians"><span class="header-section-number">2.1</span> Point Processes for Non-Mathematicians</h2>
<p>Now that we understand the hardware, let’s talk about the software. How do we mathematically describe the probability of a beat occurring <em>right now</em>?</p>
<p>In the world of continuous signals, you ask, “What is the value of X at time t?” In the world of events (point processes), you ask, “What is the probability that an event happens in the next split second, given everything that has happened so far?”</p>
<p>This instantaneous probability rate is called the <strong>Conditional Intensity Function</strong>, denoted as <span class="math inline">\(\lambda(t \mid \mathcal{H}_t)\)</span>. Think of it like a “Danger Meter” or a “Hazard Rate”.</p>
<p>Imagine you are waiting for a bus.</p>
<ul>
<li>Minute 0-5: The probability of the bus arriving is low. <span class="math inline">\(\lambda(t)\)</span> is near zero.</li>
<li>Minute 10: The scheduled arrival time is approaching. <span class="math inline">\(\lambda(t)\)</span> starts to rise.</li>
<li>Minute 15: The bus is late. The probability that it arrives in the next second is getting very high because it has to arrive eventually. <span class="math inline">\(\lambda(t)\)</span> peaks.</li>
<li>Minute 16 (Bus Arrives): The event happens!</li>
<li>Minute 16 + 1 second: The probability of another bus arriving immediately drops to zero. You just saw one; the next one won’t be here for a while. This is the Refractory Period.</li>
</ul>
<p>Standard Poisson processes (like a Geiger counter measuring radiation) have a flat intensity. They have no memory. The bus could arrive at any second with equal probability. But the heart has a memory. It <em>cannot</em> fire immediately after a beat because the ion channels need to reset (repolarize).</p>
<p>The Inverse Gaussian model captures this beautifully. Its hazard rate starts at zero (refractory), rises steeply as the “bucket” fills, and then tapers off. This shape perfectly mimics the physiological recovery of the heart tissue.</p>
<p>Let’s visualize this “Hazard Rate” profile. This curve represents the urgency of the heart to beat as time ticks by since the last beat.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Time since last spike (tau)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, <span class="fl">1.5</span>, <span class="at">length.out=</span><span class="dv">500</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fl">0.8</span>         <span class="co"># Mean interval (seconds)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>lambda_scale <span class="ot">&lt;-</span> <span class="dv">20</span> <span class="co"># Shape parameter (inverse variance)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse Gaussian PDF</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>f_ig <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(lambda_scale <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> tau<span class="sc">^</span><span class="dv">3</span>)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>lambda_scale <span class="sc">*</span> (tau <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> mu<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> tau))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Inverse Gaussian CDF</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(lambda_scale<span class="sc">/</span>tau) <span class="sc">*</span> (tau<span class="sc">/</span>mu <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>z2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sqrt</span>(lambda_scale<span class="sc">/</span>tau) <span class="sc">*</span> (tau<span class="sc">/</span>mu <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>F_ig <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(z1) <span class="sc">+</span> <span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>lambda_scale<span class="sc">/</span>mu) <span class="sc">*</span> <span class="fu">pnorm</span>(z2)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Hazard Function: lambda(t) = f(t) / (1 - F(t))</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># We add a tiny epsilon to denominator to avoid division by zero</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>hazard <span class="ot">&lt;-</span> f_ig <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> F_ig <span class="sc">+</span> <span class="fl">1e-10</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tau, hazard, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">"#D55E00"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"The Heart's 'Urgency' Function"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Time since last beat (seconds)"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Conditional Intensity (Spikes/sec)"</span>, <span class="at">frame.plot=</span><span class="cn">FALSE</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>mu, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(mu, <span class="fu">max</span>(hazard)<span class="sc">*</span><span class="fl">0.8</span>, <span class="st">"Mean Interval"</span>, <span class="at">pos=</span><span class="dv">4</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-hazard-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hazard-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="point-process_files/figure-html/fig-hazard-comparison-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hazard-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: The ‘Urgency’ to Beat. This plot shows the Conditional Intensity (Hazard Rate) for an Inverse Gaussian process. Notice how it starts at 0 (the heart refuses to beat immediately after the last one) and rises sharply as time approaches the mean interval (0.8s). This ‘Refractory’ shape is what separates biological models from simple Poisson models.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="the-sde-revolution-modeling-the-hidden-drivers" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="the-sde-revolution-modeling-the-hidden-drivers"><span class="header-section-number">2.2</span> The SDE Revolution: Modeling the “Hidden Drivers”</h2>
<p>We have our bucket (the SA node) and we have our probability curve (Inverse Gaussian). But who is turning the faucet handle? Who is changing the drift rate?</p>
<p>It is the Autonomic Nervous System (ANS). The ANS has two main branches that act like the accelerator and brake of a car:</p>
<ol type="1">
<li><strong>Sympathetic:</strong> The accelerator. It releases norepinephrine, which opens the ion channels wider, fills the bucket faster, and raises the heart rate.</li>
<li><strong>Parasympathetic (Vagal):</strong> The brake. It releases acetylcholine, which closes the channels, fills the bucket slower, and lowers the heart rate.</li>
</ol>
<p>In the Barbieri model, these inputs are estimated beat-by-beat using a regression on the past history. It works well, but it treats the inputs as discrete steps. But your nerves don’t just switch states every heartbeat; they are continuous biological flows.</p>
<p>This is where we upgrade to <strong>Stochastic Differential Equations (SDEs)</strong>. We model the sympathetic tone, let’s call it <span class="math inline">\(s(t)\)</span>, and the parasympathetic tone, <span class="math inline">\(p(t)\)</span>, as continuous variables that evolve in the background, invisible to the naked eye but driving the whole show.</p>
<p>We use the <strong>Ornstein-Uhlenbeck (OU) process</strong> to model these tones. Think of the OU process as a “Leaky Tank”.</p>
<ul>
<li>The Input (<span class="math inline">\(u(t)\)</span>): You pour water (neurotransmitters) into the tank based on external stress (exercise, math tests, scary movies).</li>
<li>The Leak (<span class="math inline">\(-a \cdot x(t)\)</span>): The tank has a hole in the bottom. If you stop pouring, the water level naturally decays back to zero. This decay rate <span class="math inline">\(a\)</span> is crucial.</li>
<li>The Noise (<span class="math inline">\(\sigma \cdot dW\)</span>): The wind is blowing over the tank, causing ripples on the surface. Biology is never perfectly smooth; there is always synaptic noise.</li>
</ul>
<p>Here is the beauty of it: biology dictates the leak size. The Parasympathetic system is fast. Acetylcholine is broken down instantly by enzymes. The tank leaks very quickly. This allows your heart rate to change in milliseconds (like when you exhale). So, <span class="math inline">\(a_p\)</span> is large (fast decay). The Sympathetic system is slow. Norepinephrine works via second messengers (G-proteins). It’s like a heavy, sluggish fluid. The tank leaks slowly. So, <span class="math inline">\(a_s\)</span> is small (slow decay).</p>
</section>
<section id="coupling-the-systems-sympathovagal-balance" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="coupling-the-systems-sympathovagal-balance"><span class="header-section-number">2.3</span> Coupling the Systems: Sympathovagal Balance</h2>
<p>These two systems don’t work in isolation. They talk to each other. Physiologists call this <strong>Sympathovagal Balance</strong>, but it is often more like a wrestling match.</p>
<p>There is a phenomenon called “Accentuated Antagonism”. When your sympathetic drive is super high (like running for your life), the parasympathetic system finds it harder to act. The “accelerator” effectively jams the “brake”.</p>
<p>We model this mathematically by coupling our SDEs. The equation for the change in parasympathetic tone, <span class="math inline">\(dp(t)\)</span>, might look like this:</p>
<p><span class="math display">\[
dp(t) = \text{Decay} + \text{Input} + \text{Crosstalk}(s(t)) + \text{Noise}
\]</span></p>
<p>The crosstalk term means the value of the <em>other</em> state influences how this state changes. This gives us a rich, interconnected system where the “hidden drivers” are dancing together, pushing and pulling the drift rate of our Inverse Gaussian bucket.</p>
<p>Let’s visualize this dance. In the code below, we simulate these two hidden processes. Notice how the blue line (Parasympathetic) is jagged and fast, while the red line (Sympathetic) is smooth and rolling. This difference in “texture” is exactly what allows us to distinguish them mathematically just by looking at the heartbeats!</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>duration <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">&lt;-</span> duration <span class="sc">/</span> dt</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>t_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, duration, <span class="at">length.out =</span> steps)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Decay rates</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>a_p <span class="ot">&lt;-</span> <span class="fl">2.0</span>  <span class="co"># Fast Vagal</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>a_s <span class="ot">&lt;-</span> <span class="fl">0.2</span>  <span class="co"># Slow Sympathetic</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Noise levels</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>sig_p <span class="ot">&lt;-</span> <span class="fl">1.0</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>sig_s <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Coupling (Sympathetic inhibits Parasympathetic)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>b_ps <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span> </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Vectors</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(steps)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">numeric</span>(steps)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">101</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Euler-Maruyama Integration</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(steps<span class="dv">-1</span>)) {</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Independent Wiener Noise</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  dw_p <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(dt))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  dw_s <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(dt))</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update s(t) - The slow driver</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ds = -a_s * s + noise</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  ds <span class="ot">&lt;-</span> <span class="sc">-</span>a_s <span class="sc">*</span> s[i] <span class="sc">*</span> dt <span class="sc">+</span> sig_s <span class="sc">*</span> dw_s</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  s[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> s[i] <span class="sc">+</span> ds</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update p(t) - The fast driver</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dp = -a_p * p + coupling * s + noise</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note the coupling: High 's' pushes 'p' down</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  dp <span class="ot">&lt;-</span> (<span class="sc">-</span>a_p <span class="sc">*</span> p[i] <span class="sc">+</span> b_ps <span class="sc">*</span> s[i]) <span class="sc">*</span> dt <span class="sc">+</span> sig_p <span class="sc">*</span> dw_p</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  p[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> p[i] <span class="sc">+</span> dp</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(t_seq, p, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">"#0072B2"</span>, <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">c</span>(p,s)),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"The Autonomic Dance: Coupled SDEs"</span>,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Time (s)"</span>, <span class="at">ylab=</span><span class="st">"Normalized Activity"</span>, <span class="at">frame.plot=</span><span class="cn">FALSE</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(t_seq, s, <span class="at">col=</span><span class="st">"#D55E00"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Parasympathetic (Fast)"</span>, <span class="st">"Sympathetic (Slow)"</span>),</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>), <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">bty=</span><span class="st">"n"</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-sde-coupling" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sde-coupling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="point-process_files/figure-html/fig-sde-coupling-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sde-coupling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The Hidden Drivers. This simulation shows the latent autonomic states. The blue Parasympathetic trace oscillates rapidly because of its fast decay rate (high a_p). The red Sympathetic trace is sluggish and smooth (low a_s). In our model, these two invisible lines combine to determine the drift rate of the pacemaker cell.
</figcaption>
</figure>
</div>
</div>
</div>
<p>This framework moves us from a purely statistical description (distributions and regressions) to a <strong>mechanistic</strong> one. We aren’t just fitting a curve to data; we are simulating the biological machinery that generated the data. The “rubber band” of the SDE (mean reversion) represents enzymatic breakdown. The “noise” represents synaptic jitter. The “coupling” represents neural cross-talk.</p>
<p>In the next phases, we will see how to put this all together to generate realistic heartbeat data and, crucially, how to work backward to infer these hidden states from a patient’s ECG.</p>
</section>
</section>
<section id="building-the-simulation-in-r" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Building the Simulation in R</h1>
<section id="step-by-step-implementation-guide" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="step-by-step-implementation-guide"><span class="header-section-number">3.1</span> Step-by-Step Implementation Guide</h2>
<p>Now that we have the blueprints, it is time to get our hands dirty in the workshop. We are going to build this digital heart using R. If the math felt heavy in the previous phase, think of this as the “Lego” stage (we are just snapping the pieces together to create a living organism).</p>
<p>To start, we need a “Stage”. In our simulation, the stage is continuous time. We don’t just track heartbeats; we track every millisecond of existence between those beats. Think of this like the frame rate in a video game like <em>Cyberpunk 2077</em>. If the frame rate is too low, the movement looks choppy. In our physiological world, if our “frame rate” (the time step <span class="math inline">\(dt\)</span>) is too coarse, we miss the fast, jittery “wiggles” of the vagus nerve. We need at least a 1ms to 5ms resolution to ensure our stochastic calculus doesn’t fall apart.</p>
<p>The most daunting term in SDE math is the <strong>Euler-Maruyama Method</strong>. Don’t let the name scare you; it’s actually the most intuitive way to simulate life. If you have ever used a GPS that estimates your arrival time based on your current speed and traffic, you’ve done something similar. It essentially says:</p>
<p><em>New State = Old State + (Average Change over Time) + (Random Shove).</em></p>
<p>In our case, the “Average Change” is the physics of the autonomic tank leaking and filling, and the “Random Shove” is the biological noise that keeps our heart from being a perfect, boring metronome.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a conceptual snippet for the loop we will use.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Imagine s[i] is the Sympathetic level right now.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We calculate the next level s[i+1] like this:</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># s[i+1] &lt;- s[i] + (-a_s * s[i]) * dt + sigma_s * rnorm(1, 0, sqrt(dt))</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Translation: </span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Start with where you are (s[i]).</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Subtract a bit because the tank leaks (-a_s * s[i]). This is the "mean reversion."</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Add a random kick (rnorm...) representing synaptic noise. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The magic happens when we connect these states to the <strong>Inverse Gaussian</strong> “bucket” we discussed. Instead of a constant drift, the speed at which our bucket fills is now a living, breathing variable. We calculate the target heart rate at every millisecond as a mix of these two signals. It is like a DJ mixing two tracks: one fast and rhythmic (Parasympathetic), one deep and slow (Sympathetic).</p>
</section>
<section id="the-thinning-algorithm-simulating-the-beat" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="the-thinning-algorithm-simulating-the-beat"><span class="header-section-number">3.2</span> The “Thinning” Algorithm: Simulating the Beat</h2>
<p>Here is the trickiest part of the whole project: how do we decide exactly when the heart should beat? In a standard simulation, you might just pick a random number from a distribution. But our “bucket” is filling up in real-time. We need to check for a beat at every single “frame” of our simulation.</p>
<p>We use something called a Bernoulli Trial, which is just a fancy math term for a weighted coin flip. Imagine a coin where the “Heads” side (the heartbeat) gets heavier and heavier as the bucket fills up.At every single step of our simulation (every 1 millisecond), the computer flips this coin. The probability of that coin landing on “Heartbeat” is determined by our Conditional Intensity Function <span class="math inline">\(\lambda(t)\)</span>.</p>
<ul>
<li>Early after a beat, the coin is weighted 99.99% toward “No Beat” (the Absolute Refractory period).</li>
<li>As time approaches the mean interval (say, 0.8 seconds), the weight shifts rapidly.</li>
<li>If a Sympathetic surge happens (you just saw a spider), the “Yes” side of the coin gets heavier much faster than usual.</li>
</ul>
<p>When the coin finally lands on “Yes”, we record the time, and we reset the internal clock. The “bucket” is empty again. This is called the Thinning Algorithm or Point Process Simulation. It is the bridge between the continuous world of nerves and the discrete world of heartbeats.</p>
</section>
<section id="coding-the-full-digital-twin" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="coding-the-full-digital-twin"><span class="header-section-number">3.3</span> Coding the Full Digital Twin</h2>
<p>Let’s build the complete engine. We will include a “Stressor” function. Imagine this as a “jump scare” or the moment you start pedaling a bike. We want to see how the SDEs respond and how that response ripples through the Inverse Gaussian probability field.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The Zero-to-Hero Heart Simulator</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This function generates a complete dataset including the hidden states</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The Robust Zero-to-Hero Heart Simulator</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>simulate_heart_verbose <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">duration_secs =</span> <span class="dv">300</span>, </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">stress_start =</span> <span class="dv">100</span>, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">stress_end =</span> <span class="dv">200</span>) {</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fl">0.005</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, duration_secs, <span class="at">by =</span> dt)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Physiological Parameters</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  a_p <span class="ot">&lt;-</span> <span class="fl">2.0</span>; sig_p <span class="ot">&lt;-</span> <span class="fl">0.2</span>; k_par <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  a_s <span class="ot">&lt;-</span> <span class="fl">0.5</span>; sig_s <span class="ot">&lt;-</span> <span class="fl">0.2</span>; k_sym <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  rho_0 <span class="ot">&lt;-</span> <span class="dv">1</span>; kappa <span class="ot">&lt;-</span> <span class="dv">20</span>     </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n); p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  lambda_trace <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n); mu_trace <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  spikes <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>); last_spike_t <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">2.0</span> </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(times <span class="sc">&gt;=</span> stress_start <span class="sc">&amp;</span> times <span class="sc">&lt;=</span> stress_end, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)) {</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Update SDE States</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    p[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> p[i] <span class="sc">+</span> (<span class="sc">-</span>a_p <span class="sc">*</span> p[i] <span class="sc">-</span> <span class="fl">1.0</span> <span class="sc">*</span> u[i]) <span class="sc">*</span> dt <span class="sc">+</span> sig_p <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(dt))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    s[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> s[i] <span class="sc">+</span> (<span class="sc">-</span>a_s <span class="sc">*</span> s[i] <span class="sc">+</span> <span class="fl">1.0</span> <span class="sc">*</span> u[i]) <span class="sc">*</span> dt <span class="sc">+</span> sig_s <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sqrt</span>(dt))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Map to Mean Interval with safety floor</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    current_rate <span class="ot">&lt;-</span> rho_0 <span class="sc">+</span> k_sym <span class="sc">*</span> s[i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> k_par <span class="sc">*</span> p[i<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We must ensure rate is positive and mu is not too small</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    current_rate <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fl">0.5</span>, current_rate) </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> current_rate</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    mu_trace[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> mu</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Calculate Inverse Gaussian Hazard</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    tau <span class="ot">&lt;-</span> times[i] <span class="sc">-</span> last_spike_t</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(tau <span class="sc">&lt;</span> <span class="fl">0.02</span>) { <span class="co"># Refractory period guard</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      lambda_val <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Numerical Protection: Limit the exponent to avoid Inf</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      exponent_term <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> kappa <span class="sc">/</span> mu</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (exponent_term <span class="sc">&gt;</span> <span class="dv">700</span>) {</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the exponent is too large, the CDF is effectively 1 or </span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the hazard is saturating. We cap it.</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        cdf_term2 <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        cdf_term2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(exponent_term) <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">sqrt</span>(kappa<span class="sc">/</span>tau)<span class="sc">*</span>(tau<span class="sc">/</span>mu <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>      term_pdf <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(kappa<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>tau<span class="sc">^</span><span class="dv">3</span>)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>kappa<span class="sc">*</span>(tau<span class="sc">-</span>mu)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>mu<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>tau))</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      term_cdf <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(<span class="fu">sqrt</span>(kappa<span class="sc">/</span>tau)<span class="sc">*</span>(tau<span class="sc">/</span>mu <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">+</span> cdf_term2</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Final Hazard Calculation with a safety ceiling</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 1e-9 prevents division by zero; pmin caps the intensity</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>      lambda_val <span class="ot">&lt;-</span> term_pdf <span class="sc">/</span> <span class="fu">max</span>(<span class="fl">1e-9</span>, (<span class="dv">1</span> <span class="sc">-</span> term_cdf))</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If lambda_val is still NaN or Inf due to tau/mu edge cases, set to 0</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(lambda_val) <span class="sc">||</span> <span class="fu">is.infinite</span>(lambda_val)) {</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        lambda_val <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    lambda_trace[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> lambda_val</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Bernoulli Trial</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for NA here as a final safety measure</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(lambda_val) <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> lambda_val <span class="sc">*</span> dt) {</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>      spikes <span class="ot">&lt;-</span> <span class="fu">c</span>(spikes, times[i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>      last_spike_t <span class="ot">&lt;-</span> times[i<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">time=</span>times, <span class="at">s=</span>s, <span class="at">p=</span>p, <span class="at">spikes=</span>spikes, <span class="at">u=</span>u, <span class="at">mu=</span>mu_trace, <span class="at">lam=</span>lambda_trace))</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulation</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">simulate_heart_verbose</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="validation-application" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Validation &amp; Application</h1>
<section id="analyzing-the-virtual-patient" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="analyzing-the-virtual-patient"><span class="header-section-number">4.1</span> Analyzing the “Virtual Patient”</h2>
<p>If our model is any good, it should behave like a real person. Let’s look at our simulation results through the lens of a clinician. In this phase, we move from being “Engineers” to being “Analysts”.</p>
<p>Imagine you are looking at a dashboard in an ICU. You have the raw ECG, but you also have these magical “augmented reality” glasses that show you the invisible nervous system activity. In the plot below, we visualize exactly that.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate intervals</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>rr_intervals <span class="ot">&lt;-</span> <span class="fu">diff</span>(sim_data<span class="sc">$</span>spikes)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>rr_times <span class="ot">&lt;-</span> sim_data<span class="sc">$</span>spikes[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dv">3</span>, <span class="dv">1</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>), <span class="at">heights=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">oma=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: The Input</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sim_data<span class="sc">$</span>time, sim_data<span class="sc">$</span>u, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">"black"</span>, </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"External Stress"</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">frame.plot=</span>F)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: The Latent Drivers</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sim_data<span class="sc">$</span>time, sim_data<span class="sc">$</span>p, <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span><span class="st">"#0072B2"</span>, <span class="at">lwd=</span><span class="dv">1</span>, </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Autonomic Tone"</span>, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">frame.plot=</span>F, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(sim_data<span class="sc">$</span>time, sim_data<span class="sc">$</span>s, <span class="at">col=</span><span class="st">"#D55E00"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Parasympathetic"</span>, <span class="st">"Sympathetic"</span>), </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 3: The Observed R-R Intervals (Tachogram)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rr_times, rr_intervals <span class="sc">*</span> <span class="dv">1000</span>, <span class="at">type=</span><span class="st">'b'</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">bg=</span><span class="st">"white"</span>, <span class="at">col=</span><span class="st">"black"</span>,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"R-R Interval (s)"</span>, <span class="at">xlab=</span><span class="st">"Time (s)"</span>, <span class="at">frame.plot=</span>F)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-deep-dive" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-deep-dive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="point-process_files/figure-html/fig-deep-dive-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-deep-dive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The Anatomy of a Stress Response. Top: The ‘Stressor’ represents an external challenge. Middle: The latent states respond with different time-constants. Note the ‘Vagal Crash’ and ‘Sympathetic Rise’. Bottom: The R-R intervals (Tachogram) show the tangible result of these hidden battles.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Look closely at the transition at second 40. The moment the stress starts, the blue line (Parasympathetic) vanishes almost instantly. This is “Vagal Withdrawal”. Because the blue line was providing high-frequency “jitter”, notice how the R-R intervals not only get shorter but also become more “regular” or “stiff”. This is a classic hallmark of stress: a loss of complexity.</p>
<p>Then, at second 80, when the stress stops, the blue line bounces back quickly, but the red line (Sympathetic) lingers. This is why your heart keeps pounding for a minute after a narrow miss in traffic. The “Sympathetic Tail” is a direct result of our SDE time-constants (<span class="math inline">\(a_s\)</span>).</p>
</section>
<section id="comparison-with-barbieri-et-al.-2005-the-philosophical-shift" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="comparison-with-barbieri-et-al.-2005-the-philosophical-shift"><span class="header-section-number">4.2</span> Comparison with Barbieri et al.&nbsp;(2005): The Philosophical Shift</h2>
<p>When Barbieri and his colleagues published their seminal paper in 2005, they changed the game by introducing the <strong>Point Process</strong> framework. They argued that we should stop interpolating heartbeats into “fake” continuous signals and instead model the probability of the events themselves.</p>
<p>However, most implementations of the Barbieri model are “discrete-time”. They update their parameters once per beat. Our SDE-Inverse Gaussian model is a direct evolution of their work.</p>
<p>Think of the difference like this:</p>
<ul>
<li><strong>The Barbieri Approach (Discrete):</strong> It’s like a turn-based strategy game (like <em>Civilization</em>). You make a move, then the heart beats, then you update your knowledge.</li>
<li><strong>The SDE Approach (Continuous):</strong> It’s like a real-time strategy game (like <em>Starcraft</em>). Things are changing every millisecond, and a beat can happen at any moment in that flux.</li>
</ul>
<p>Why does this matter? Because of <strong>Sub-Beat Dynamics</strong>. If you take a deep breath, your heart rate starts changing <em>immediately</em>, even before the next beat happens. A discrete model is always “lagging” behind the biology by one interval. Our SDE model is “synced” with the actual nervous system.</p>
</section>
<section id="the-inverse-problem-becoming-a-physiological-detective" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="the-inverse-problem-becoming-a-physiological-detective"><span class="header-section-number">4.3</span> The Inverse Problem: Becoming a Physiological Detective</h2>
<p>We have spent our time being “God” (setting the parameters and generating the heartbeats). But in the real world, you are a “Detective”. You have the ECG recording, and you want to find the hidden red and blue lines. You want to know: “How stressed is this patient?”</p>
<p>This is the <strong>Inference Problem</strong>. Because our model is a “State-Space Model”, we can use the most powerful tools in statistics to solve it.</p>
<p>The primary tool is the <strong>Point Process Filter</strong> (an evolution of the Kalman Filter). Imagine you are trying to track a person walking in a dark room using only the sound of their footsteps.</p>
<ol type="1">
<li><strong>Prediction:</strong> Based on the last step, you guess where they will step next.</li>
<li><strong>Correction:</strong> You hear a “thud”. If it was further right than you thought, you update your estimate of their path and speed.</li>
</ol>
<p>In our model, every heartbeat is a “thud”. If the heart beats earlier than expected, our “Detective” (the filter) concludes that the Sympathetic driver must have increased.</p>
<p>For the R-coding hero, this is where you move beyond simple loops and into packages like <code>pomp</code> (Partially Observed Markov Processes) or <code>TMB</code> (Template Model Builder). These tools allow you to feed in a CSV of heartbeat times and (using Maximum Likelihood or Bayesian estimation) extract the hidden <span class="math inline">\(s(t)\)</span> and <span class="math inline">\(p(t)\)</span> trajectories. This is “Precision Medicine” in action.</p>
</section>
<section id="why-this-model-is-a-game-changer-for-applied-science" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="why-this-model-is-a-game-changer-for-applied-science"><span class="header-section-number">4.4</span> Why This Model is a Game Changer for Applied Science</h2>
<p>If you are a sports scientist, a psychologist, or a cardiologist, why should you care about SDEs and Inverse Gaussians?</p>
<p>Because standard HRV (like LF/HF ratios) is notoriously unreliable. It’s easily “broken” by breathing patterns or movement. By using a generative model, we can <strong>disentangle</strong> the components. We can explicitly say: “This part of the heart rate change is due to the fast vagal response to breathing, and this part is the slow sympathetic response to the workout”.</p>
<p>We are moving from a world of “indices” to a world of “mechanisms”.</p>
</section>
<section id="conclusion-the-symphony-of-the-sinus-node" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="conclusion-the-symphony-of-the-sinus-node"><span class="header-section-number">4.5</span> Conclusion: The Symphony of the Sinus Node</h2>
<p>We have reached the end of our journey. We started with the biophysics of a single cell membrane, built a stochastic “leaky bucket” model, drove it with hidden differential equations, and finally generated a synthetic heart rate that looks and acts like a human one.</p>
<p>The heart it’s a storyteller. It’s an interface between your brain and the physical world. And with these mathematical tools (SDEs, Point Processes, and the Inverse Gaussian distribution) we are finally learning to listen to the story it tells in the silence between the beats.</p>
<p>You are now a “Hero” of this model. You understand that the “jitter” in your pulse it’s the signature of a complex, living control system. So go ahead: download the code, tweak the time-constants, and start exploring the “Hidden Drivers” of the human heart.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>