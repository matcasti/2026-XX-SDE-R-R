---
title: "A Continuous-Time Stochastic State-Space Framework for Heart Rate Variability"
subtitle: "The SDE-Inverse Gaussian Model"
author: "Mat√≠as Castillo-Aguilar"
date: today
format: 
  html:
    code-fold: show
    toc: true
    number-sections: true
    theme: cosmo
---

For a deep dive into point processes models applied for modeling R-R intervals, please check this [Zero-to-Hero guide](docs/point-process.html)!

# Abstract

We propose a hybrid generative model for heart rate variability that integrates the biophysical rigor of the Inverse Gaussian first-passage time distribution with the continuous dynamical flexibility of stochastic differential equations. Existing approaches often rely on discrete autoregressive structures that discretize physiological time or Poisson-based intensity functions that lack the specific integrate-and-fire mechanics of the sinoatrial node. The framework presented herein models the latent sympathetic and parasympathetic autonomic drives as coupled Ornstein-Uhlenbeck processes. These continuous states dynamically modulate the drift parameter of an Inverse Gaussian probability density which governs the precise timing of the next heartbeat. This formulation preserves the continuous nature of autonomic control while accurately reproducing the stochastic properties of membrane depolarization thresholds.

# Introduction

The statistical modeling of heart rate variability requires a unified framework that accounts for the discrete nature of the heartbeat event and the continuous nature of the underlying physiological drivers. The sinoatrial node functions as a biological oscillator where membrane potential rises via ionic currents until a threshold is reached, triggering an action potential. This biophysical process of accumulation to a threshold is mathematically described by a random walk with drift, the first-passage times of which follow an Inverse Gaussian distribution.

While stationary Inverse Gaussian models successfully describe resting heart rate distributions, they typically fail to capture the complex, time-varying dynamics of the autonomic nervous system during non-stationary conditions such as exercise or postural changes. Conversely, standard point process models that employ log-linear intensity functions often treat the heart as a Poisson-like generator, neglecting the intrinsic refractory and integrative properties of the cardiac tissue.

To resolve these limitations, we introduce a state-space formulation where the parameters of the Inverse Gaussian observation model are not static or discretely updated, but are driven by continuous stochastic differential equations (SDEs). This approach allows for the explicit representation of the distinct time scales of the sympathetic and parasympathetic branches  while maintaining the rigorous probabilistic structure of the Inverse Gaussian renewal process.

# Latent Autonomic Dynamics

The unobserved physiological state of the system is defined by a vector $\mathbf{x}(t) = [p(t), s(t)]^T$, representing the instantaneous activity of the parasympathetic and sympathetic branches, respectively. Unlike discrete-time models that update state variables only upon the occurrence of a heartbeat, we model these states as continuous stochastic processes governing the system evolution between events.

## The Coupled Stochastic Differential Equations

The evolution of the autonomic states is governed by a system of linear stochastic differential equations. This formulation allows for the directed coupling of the two branches, capturing phenomena such as sympathovagal balance and accentuated antagonism. The system is defined as follows:

$$
\begin{aligned}
dp(t) &= \left( -a_{p}p(t) + b_{ps}s(t) + c_{p}u(t) \right) dt + \sigma_{p}dW_{p}(t) \\
ds(t) &= \left( -a_{s}s(t) + b_{sp}p(t) + c_{s}u(t) \right) dt + \sigma_{s}dW_{s}(t)
\end{aligned}
$$

The parameters $a_p$ and $a_s$ represent the decay rates of the parasympathetic and sympathetic responses. Physiologically, the vagal (parasympathetic) response is rapid, mediated by direct acetylcholine-gated channels, implying a large value for $a_p$. The sympathetic response is slower, mediated by second-messenger systems, implying a smaller value for $a_s$. The terms $b_{ps}$ and $b_{sp}$ quantify the cross-branch coupling, while $u(t)$ represents an exogenous forcing function such as respiration or workload, scaled by sensitivity coefficients $c_p$ and $c_s$. The stochastic innovations $dW_p(t)$ and $dW_s(t)$ are increments of independent Wiener processes, introducing intrinsic biological noise into the control loop.

We visualize the behavior of these coupled states below. The simulation demonstrates how the two branches respond differently to the same stochastic perturbations due to their distinct time constants.

```{r}
#| label: fig-latent-sde
#| fig-cap: "Trajectory of Latent Autonomic States. The blue trace (Parasympathetic) exhibits high-frequency variability due to its fast decay rate, while the red trace (Sympathetic) shows smoother, low-frequency trends. This frequency separation is intrinsic to the SDE formulation."

sim_latent_sde <- function(duration = 60, dt = 0.01) {
  n_steps <- duration / dt
  times <- seq(0, duration, length.out = n_steps)
  
  # Parameters defining the timescales
  a_p <- 2.5   # Fast vagal decay
  a_s <- 0.2   # Slow sympathetic decay
  sigma_p <- 1.0
  sigma_s <- 0.5
  
  # Initialization
  p <- numeric(n_steps)
  s <- numeric(n_steps)
  
  set.seed(42)
  # Euler-Maruyama Integration
  for(i in 1:(n_steps-1)) {
    # Generate Wiener increments
    dw_p <- rnorm(1, sd = sqrt(dt))
    dw_s <- rnorm(1, sd = sqrt(dt))
    
    # Update equations (uncoupled for clear visualization of timescales)
    dp <- -a_p * p[i] * dt + sigma_p * dw_p
    ds <- -a_s * s[i] * dt + sigma_s * dw_s
    
    p[i+1] <- p[i] + dp
    s[i+1] <- s[i] + ds
  }

  # Visualization
  par(mfrow = c(2, 1), mar = c(3, 5, 2, 2))
  plot(times, p, type = 'l', col = "#0072B2", lwd = 1,
       ylab = "Parasympathetic p(t)", xaxt = 'n', frame.plot = FALSE,
       main = "Latent Stochastic Processes")
  grid(col = "lightgray")
  
  plot(times, s, type = 'l', col = "#D55E00", lwd = 2,
       ylab = "Sympathetic s(t)", xlab = "Time (s)", frame.plot = FALSE)
  grid(col = "lightgray")
}

sim_latent_sde()

```

# The Inverse Gaussian Observation Model

The transition from the continuous latent states to the discrete event times requires a probabilistic mapping. We employ the Inverse Gaussian distribution  to describe the probability density of the waiting time until the next beat. The critical innovation in this framework is that the parameters of this distribution are not static; they are modulated instantaneously by the SDE states.

## The Time-Varying Mean Interval

We define the instantaneous target heart rate $\rho(t)$ as a linear combination of the baseline pacing rate and the autonomic modulators. Consistent with physiological conventions where sympathetic activity increases rate and parasympathetic activity decreases it, we write:

$$
\rho(t) = \rho_0 + k_{sym}s(t) - k_{par}p(t)
$$

The instantaneous mean R-R interval $\mu(t)$, which serves as the location parameter for the Inverse Gaussian density, is the reciprocal of this rate: $\mu(t) = 1 / \rho(t)$.

## The Conditional Intensity Function

For point process simulation and likelihood estimation, we require the conditional intensity function $\lambda(t | \mathcal{H}_t)$. This function is derived from the Inverse Gaussian probability density function (PDF) $f(t)$ and its cumulative distribution function (CDF) $F(t)$.

The PDF for the time $t$ of the next beat, given the previous beat occurred at $u_k$, is:

$$
f(t \mid u_k, \mathbf{x}(t)) = \left[ \frac{\kappa}{2\pi(t-u_k)^3} \right]^{1/2} \exp \left\{ -\frac{\kappa [ (t-u_k) - \mu(t) ]^2 }{ 2 \mu(t)^2 (t-u_k) } \right\}
$$

Here, $\kappa$ is the shape parameter (analogous to $\theta_{p+1}$ in Barbieri et al. 2005), which determines the variance and skewness of the interval distribution.

The conditional intensity is defined as the hazard rate:

$$ 
\lambda(t \mid \mathcal{H}_t) = \frac{f(t \mid u_k, \mathbf{x}(t))}{1 - F(t \mid u_k, \mathbf{x}(t))}
$$

This function rises sharply as the time elapsed since the last beat $t - u_k$ approaches the target mean $\mu(t)$, effectively representing the increasing probability of depolarization threshold crossing. Unlike Poisson intensities which are often flat or monotonic, the Inverse Gaussian hazard function naturally incorporates a refractory period (where $\lambda \approx 0$ for small $t-u_k$) and a rapid rise, mirroring the biophysics of the cardiac cycle.

The code below visualizes this hazard function, demonstrating how a shift in the autonomic state (changing $\mu(t)$) alters the probability profile of the next beat.

```{r}
#| label: fig-hazard-function
#| fig-cap: "The Inverse Gaussian Hazard Function. The solid line represents the conditional intensity under baseline conditions. The dashed line shows the effect of sympathetic activation, which shortens the mean interval mu(t) and shifts the steep rising phase of the intensity to the left, increasing the probability of an earlier beat."

plot_ig_hazard <- function() {
  # Define time axis (time since last beat)
  tau <- seq(0.01, 3.0, length.out = 500)
  
  # Helper to compute Hazard
  calc_hazard <- function(tau_vec, mu_val, lambda_scale) {
    pdf_val <- numeric(length(tau_vec))
    cdf_val <- numeric(length(tau_vec))
    
    # Calculate PDF and CDF for Inverse Gaussian
    for(i in seq_along(tau_vec)) {
      t <- tau_vec[i]
      # PDF
      term1 <- sqrt(lambda_scale / (2 * pi * t^3))
      term2 <- exp(-lambda_scale * (t - mu_val)^2 / (2 * mu_val^2 * t))
      pdf_val[i] <- term1 * term2
      
      # CDF
      z1 <- sqrt(lambda_scale/t) * (t/mu_val - 1)
      z2 <- -sqrt(lambda_scale/t) * (t/mu_val + 1)
      cdf_val[i] <- pnorm(z1) + exp(2*lambda_scale/mu_val) * pnorm(z2)
    }
    
    # Hazard = PDF / Survival
    survival <- 1 - cdf_val
    survival[survival < 1e-6] <- 1e-6 # Numerical floor
    return(pdf_val / survival)
  }
  
  # Scenario 1: Baseline (Mean Interval = 0.8s, approx 75 BPM)
  h_base <- calc_hazard(tau, mu_val = 0.8, lambda_scale = 15)
  
  # Scenario 2: Sympathetic Activation (Mean Interval = 0.5s, 120 BPM)
  h_sym <- calc_hazard(tau, mu_val = 0.5, lambda_scale = 15)
  
  par(mar = c(5, 5, 2, 2))
  plot(tau, h_base, type = 'l', lwd = 3, col = "black", ylim = c(0, 40),
       xlab = "Time since last beat (s)", ylab = expression(lambda(t * "|" * H[t])),
       main = "Conditional Intensity Dynamics", frame.plot = FALSE)
  lines(tau, h_sym, lwd = 3, col = "#D55E00", lty = 2)
  
  legend("topleft", legend = c("Baseline State", "Sympathetic State"),
         col = c("black", "#D55E00"), lty = c(1, 2), lwd = 3, bty = "n")
  grid(col = "lightgray")
}

plot_ig_hazard()

```

# Numerical Simulation Algorithm

The integration of the continuous SDEs with the discrete point process requires a hybrid numerical scheme. We utilize the Euler-Maruyama method for the state evolution and a time-rescaling (or thinning) approach for the event generation. The simulation proceeds in discrete time steps $dt$, yet approximates the continuous-time intensity dynamics.

At each time step $t_i$:

State Update: The values of $p(t_i)$ and $s(t_i)$ are updated using the finite difference form of the coupled SDEs.
Parameter Mapping: The current autonomic states determine the instantaneous mean interval $\mu(t_i)$.
Intensity Evaluation: The conditional intensity $\lambda(t_i)$ is calculated based on the current $\mu(t_i)$ and the time elapsed since the last event $t_i - u_{last}$.
Event Generation: The probability of a heartbeat occurring in the interval $[t_i, t_i + dt)$ is approximated by $\lambda(t_i) dt$. A Bernoulli trial determines if an event occurs. If successful, $u_{last}$ is updated to $t_i$.

The complete algorithm is implemented in the R function below. This function encapsulates the entire generative process, allowing for the exploration of how different autonomic coupling parameters influence the resulting heart rate variability.

```{r}
#| label: full-simulation-code

#' Simulate SDE-Driven Inverse Gaussian Point Process
#'
#' @param duration Total simulation time (s)
#' @param dt Integration time step (s)
#' @param params List of model parameters
#' @param input_fn Function u(t) for exogenous input
sim_sde_ig_process <- function(duration, dt, params, input_fn) {
  
  n_steps <- ceiling(duration / dt)
  time_grid <- seq(0, by = dt, length.out = n_steps)
  
  # State Vectors
  p <- numeric(n_steps)
  s <- numeric(n_steps)
  lambda <- numeric(n_steps)
  mu_vec <- numeric(n_steps)
  
  # Event Storage
  spikes <- numeric(0)
  last_spike_t <- -1.0 # Initialize before start
  
  # Pre-compute noise for efficiency
  dW_p <- rnorm(n_steps, 0, sqrt(dt))
  dW_s <- rnorm(n_steps, 0, sqrt(dt))
  
  # Parameter Unpacking
  a_p <- params$a_p; a_s <- params$a_s
  b_ps <- params$b_ps; b_sp <- params$b_sp
  c_p <- params$c_p; c_s <- params$c_s
  sig_p <- params$sig_p; sig_s <- params$sig_s
  
  rho_0 <- params$rho_0
  k_sym <- params$k_sym
  k_par <- params$k_par
  lambda_scale <- params$lambda_scale
  
  for(i in 1:(n_steps-1)) {
    t <- time_grid[i]
    
    # 1. Evaluate Input
    u_val <- input_fn(t)
    
    # 2. Update SDE States (Euler-Maruyama)
    # p(t+dt) = p(t) + (-a_p*p + b_ps*s + c_p*u)*dt + sig*dW
    dp <- (-a_p * p[i] + b_ps * s[i] + c_p * u_val) * dt + sig_p * dW_p[i]
    ds <- (-a_s * s[i] + b_sp * p[i] + c_s * u_val) * dt + sig_s * dW_s[i]
    
    p[i+1] <- p[i] + dp
    s[i+1] <- s[i] + ds
    
    # 3. Map to Mean Interval mu(t)
    # Rate rho(t) = Base + Sym - Par
    current_rate <- rho_0 + k_sym * s[i+1] - k_par * p[i+1]
    # Safety: Rate must be positive
    if(current_rate < 0.5) current_rate <- 0.5
    
    current_mu <- 1 / current_rate
    mu_vec[i+1] <- current_mu
    
    # 4. Calculate Conditional Intensity (Hazard)
    tau <- t - last_spike_t
    
    # Safety: Avoid singularity at tau=0
    if (tau < 1e-3) {
      lambda_val <- 0
    } else {
      # Inverse Gaussian PDF
      term1 <- sqrt(lambda_scale / (2 * pi * tau^3))
      term2 <- exp(-lambda_scale * (tau - current_mu)^2 / (2 * current_mu^2 * tau))
      pdf_val <- term1 * term2
      
      # Inverse Gaussian CDF
      z1 <- sqrt(lambda_scale/tau) * (tau/current_mu - 1)
      z2 <- -sqrt(lambda_scale/tau) * (tau/current_mu + 1)
      cdf_val <- pnorm(z1) + exp(2 * lambda_scale / current_mu) * pnorm(z2)
      
      survival <- 1 - cdf_val
      if(survival < 1e-8) survival <- 1e-8
      
      lambda_val <- pdf_val / survival
    }
    
    lambda[i+1] <- lambda_val
    
    # 5. Event Generation (Bernoulli)
    prob_fire <- lambda_val * dt
    # Safety: Probability cannot exceed 1
    if(prob_fire > 1) prob_fire <- 1
    
    if(runif(1) < prob_fire) {
      spikes <- c(spikes, t)
      last_spike_t <- t
    }
  }
  
  return(list(time = time_grid, p = p, s = s, mu = mu_vec, spikes = spikes))
}

```

# Simulation Results and Discussion

To validate the model, we simulate a hypothetical physiological stress test. The protocol imposes a rectangular boxcar stimulus $u(t)$ representing a period of physical exertion. We expect the model to exhibit a withdrawal of parasympathetic tone and an increase in sympathetic tone, leading to a reduction in the mean R-R interval and a concomitant change in the stochastic structure of the beat train.

The parameters for the simulation are selected to mimic human physiology: a baseline heart rate of 60 BPM ($\rho_0 = 1$), rapid vagal dynamics ($a_p = 2.0$), and slower sympathetic dynamics ($a_s = 0.2$). The scaling parameter $\kappa$ (lambda_scale) is set to 20, reflecting a realistic variance for healthy sinus rhythm.

```{r}
#| label: fig-results
#| fig-cap: "Simulation of Autonomic Response to Stress. Top: The exogenous input u(t) (black) drives the system. Middle: The autonomic states diverge; Sympathetic (red) rises slowly, Parasympathetic (blue) is suppressed. Bottom: The resulting tachogram (R-R intervals). Note the immediate shortening of intervals at onset and the gradual recovery at offset, driven by the SDE dynamics."
#| fig-height: 8

# Define Input: Stress ON between t=300 and t=420
input_boxcar <- function(t) {
  if(t >= 300 && t <= 420) return(1) else return(0)
}

# Parameter Set
params <- list(
  a_p = 2.0, b_ps = 0.0, c_p = -1.0, sig_p = 0.5, # Vagal Withdrawal
  a_s = 0.2, b_sp = 0.0, c_s = 0.5,  sig_s = 0.2, # Sympathetic Activation
  rho_0 = 1.0,  # 60 BPM baseline
  k_sym = 0.8,
  k_par = 0.8,
  lambda_scale = 20
)

# Run Simulation
set.seed(2026)
res <- sim_sde_ig_process(duration = 720, dt = 0.005, params, input_boxcar)

# Visualization
layout(matrix(c(1, 2, 3), 3, 1, byrow=TRUE), heights=c(1, 1.5, 2))
par(mar = c(2, 5, 2, 2), oma = c(2,0,0,0))

# 1. Input
plot(res$time, sapply(res$time, input_boxcar), type='l', lwd=2, 
     ylab="Input u(t)", xaxt='n', frame.plot=FALSE)
grid(col="lightgray")

# 2. States
plot(res$time, res$s, type='l', col="#D55E00", lwd=2, ylim=range(c(res$s, res$p)),
     ylab="Autonomic States", xaxt='n', frame.plot=FALSE)
lines(res$time, res$p, col="#0072B2", lwd=1.5)
legend("topleft", legend=c("Sympathetic", "Parasympathetic"), 
       col=c("#D55E00", "#0072B2"), lwd=c(2, 1.5), bty="n")
grid(col="lightgray")

# 3. Tachogram (RR Intervals)
rr_intervals <- diff(res$spikes)
beat_times <- res$spikes[-1]
plot(beat_times, rr_intervals, type='o', pch=20, cex=0.6, col="darkgrey",
     ylab="R-R Interval (s)", xlab="Time (s)", frame.plot=FALSE)
# Overlay the theoretical mean mu(t) sampled at beat times
# We find the index in time_grid closest to each beat time
mu_at_beats <- approx(res$time, res$mu, xout = beat_times)$y
lines(beat_times, mu_at_beats, col="black", lwd=2)
legend("bottomleft", legend=c("R-R Intervals", "Theoretical Mean mu(t)"),
       col=c("darkgrey", "black"), pch=c(20, NA), lty=c(1, 1), bty="n")
grid(col="lightgray")

```

The results underscore the efficacy of the proposed model. The upper panel displays the square-wave input, representing the transition from rest to exercise and back. The middle panel reveals the differential kinetics of the autonomic branches: the parasympathetic state (blue) responds rapidly to the onset and offset of the stimulus, whereas the sympathetic state (red) exhibits a damped, inertial response.

Crucially, the bottom panel demonstrates that the generated R-R intervals are not deterministic. They fluctuate stochastically around the time-varying theoretical mean $\mu(t)$ (black line). The variance of these fluctuations is not arbitrary but is governed by the Inverse Gaussian scaling parameter $\kappa$ and the instantaneous mean, consistent with the known property that heartbeat variance is dependent on the mean rate. By successfully coupling continuous SDE drivers with the rigorous Inverse Gaussian observation model, this framework provides a physiologically grounded engine for generating synthetic heart rate variability data with realistic temporal and spectral characteristics.
